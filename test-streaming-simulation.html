<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streaming Simulation Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
    }
    .info {
      background-color: #e3f2fd;
      border: 1px solid #1976d2;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .controls {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 20px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .control-group {
      margin-bottom: 15px;
    }
    .control-group label {
      display: inline-block;
      width: 150px;
      font-weight: bold;
    }
    .control-group input[type="range"] {
      width: 200px;
      vertical-align: middle;
    }
    .control-group select {
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #ced4da;
    }
    .control-group button {
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .control-group button:hover {
      background-color: #0056b3;
    }
    .control-group button.secondary {
      background-color: #6c757d;
    }
    .control-group button.secondary:hover {
      background-color: #5a6268;
    }
    .test-section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    .comparison-box {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 4px;
    }
    .comparison-box h3 {
      margin-top: 0;
      color: #495057;
    }
    #inline-container-streaming,
    #inline-container-instant {
      height: 500px;
      border: 2px dashed #999;
      background-color: #fafafa;
      margin-top: 10px;
    }
    .value-display {
      display: inline-block;
      min-width: 50px;
      font-weight: normal;
      color: #007bff;
    }
    .feature-info {
      background-color: #fff3cd;
      border: 1px solid #856404;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .test-messages {
      margin-top: 20px;
    }
    .test-messages button {
      margin: 5px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Streaming Simulation Test</h1>
    
    <div class="info">
      <h3>Testing Streaming Simulation Feature</h3>
      <p>This page tests the client-side streaming simulation that makes AI responses appear progressively:</p>
      <ul>
        <li><strong>Word Mode:</strong> Displays response word by word</li>
        <li><strong>Character Mode:</strong> Displays response character by character</li>
        <li><strong>Adjustable Speed:</strong> Control how fast text appears</li>
        <li><strong>Toggle On/Off:</strong> Compare with instant display</li>
      </ul>
    </div>

    <div class="feature-info">
      <h3>How It Works</h3>
      <p>Since the TypingMind API doesn't support real streaming, this feature simulates it by:</p>
      <ol>
        <li>Receiving the complete response from the API</li>
        <li>Hiding the typing indicator when streaming starts</li>
        <li>Progressively displaying the text chunk by chunk</li>
        <li>Maintaining proper markdown formatting during streaming</li>
      </ol>
    </div>

    <div class="controls">
      <h3>Streaming Controls</h3>
      
      <div class="control-group">
        <label>Enable Streaming:</label>
        <input type="checkbox" id="enableStreaming" checked>
      </div>
      
      <div class="control-group">
        <label>Streaming Mode:</label>
        <select id="streamingMode">
          <option value="word" selected>Word by Word</option>
          <option value="character">Character by Character</option>
        </select>
      </div>
      
      <div class="control-group">
        <label>Streaming Speed:</label>
        <input type="range" id="streamingSpeed" min="10" max="200" value="40" step="10">
        <span class="value-display" id="speedValue">40ms</span>
      </div>
      
      <div class="control-group">
        <button onclick="applySettings()">Apply Settings</button>
        <button onclick="resetSettings()" class="secondary">Reset to Defaults</button>
      </div>
    </div>

    <div class="test-section">
      <h2>Side-by-Side Comparison</h2>
      <div class="comparison">
        <div class="comparison-box">
          <h3>With Streaming Simulation</h3>
          <div id="inline-container-streaming"></div>
        </div>
        <div class="comparison-box">
          <h3>Without Streaming (Instant)</h3>
          <div id="inline-container-instant"></div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>Test Messages</h2>
      <p>Click these buttons to send pre-written test messages that showcase different response types:</p>
      <div class="test-messages">
        <button onclick="sendTestMessage('short')">Short Response</button>
        <button onclick="sendTestMessage('medium')">Medium Response</button>
        <button onclick="sendTestMessage('long')">Long Response</button>
        <button onclick="sendTestMessage('markdown')">Markdown Response</button>
        <button onclick="sendTestMessage('code')">Code Response</button>
      </div>
    </div>

    <div class="test-section">
      <h2>Popup Mode Test</h2>
      <p>The floating chat button in the bottom-right also uses the current streaming settings.</p>
    </div>
  </div>

  <!-- Load widget from local build -->
  <script src="./widget/dist/widget.js"></script>
  
  <script>
    // Configure worker URL for local development
    const workerUrl = 'http://localhost:8787';
    
    // Track widget instances
    let streamingWidget = null;
    let instantWidget = null;
    let popupWidget = null;
    
    // Test messages
    const testMessages = {
      short: "Tell me a fun fact in one sentence.",
      medium: "Explain what JavaScript is in 3-4 sentences.",
      long: "Give me a detailed explanation of how web browsers work.",
      markdown: "Show me a markdown example with headers, lists, and **bold** text.",
      code: "Write a simple JavaScript function to calculate fibonacci numbers."
    };
    
    // Initialize widgets
    function initializeWidgets() {
      // Streaming widget
      const streamingConfig = {
        instanceId: 'seo-assistant',
        container: document.getElementById('inline-container-streaming'),
        embedMode: 'inline',
        workerUrl: workerUrl,
        enableStreaming: document.getElementById('enableStreaming').checked,
        streamingSpeed: parseInt(document.getElementById('streamingSpeed').value),
        streamingMode: document.getElementById('streamingMode').value,
        onMessage: (msg) => {
          console.log('Streaming widget - Message:', msg);
        }
      };
      
      // Instant widget (no streaming)
      const instantConfig = {
        instanceId: 'seo-assistant',
        container: document.getElementById('inline-container-instant'),
        embedMode: 'inline',
        workerUrl: workerUrl,
        enableStreaming: false,
        onMessage: (msg) => {
          console.log('Instant widget - Message:', msg);
        }
      };
      
      // Popup widget (uses streaming settings)
      const popupConfig = {
        instanceId: 'support-bot',
        workerUrl: workerUrl,
        enableStreaming: document.getElementById('enableStreaming').checked,
        streamingSpeed: parseInt(document.getElementById('streamingSpeed').value),
        streamingMode: document.getElementById('streamingMode').value,
        onMessage: (msg) => {
          console.log('Popup widget - Message:', msg);
        }
      };
      
      // Initialize widgets
      if (typeof TypingMindChat !== 'undefined') {
        streamingWidget = TypingMindChat.init(streamingConfig);
        instantWidget = TypingMindChat.init(instantConfig);
        popupWidget = TypingMindChat.init(popupConfig);
      } else {
        console.error('TypingMindChat not loaded');
      }
    }
    
    // Apply settings
    function applySettings() {
      // Remove existing widgets
      const containers = ['inline-container-streaming', 'inline-container-instant'];
      containers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
          container.innerHTML = '';
        }
      });
      
      // Reinitialize with new settings
      setTimeout(initializeWidgets, 100);
    }
    
    // Reset settings
    function resetSettings() {
      document.getElementById('enableStreaming').checked = true;
      document.getElementById('streamingMode').value = 'word';
      document.getElementById('streamingSpeed').value = 40;
      updateSpeedDisplay();
      applySettings();
    }
    
    // Update speed display
    function updateSpeedDisplay() {
      const speed = document.getElementById('streamingSpeed').value;
      document.getElementById('speedValue').textContent = speed + 'ms';
    }
    
    // Send test message
    async function sendTestMessage(type) {
      const message = testMessages[type];
      if (!message) return;
      
      // Send to both widgets for comparison
      if (streamingWidget && streamingWidget.sendMessage) {
        // This would need to be implemented in the widget API
        console.log('Would send to streaming widget:', message);
      }
      
      if (instantWidget && instantWidget.sendMessage) {
        // This would need to be implemented in the widget API
        console.log('Would send to instant widget:', message);
      }
      
      // For now, alert the user to manually type the message
      alert('Please type this message in both chat widgets:\n\n' + message);
    }
    
    // Event listeners
    document.getElementById('streamingSpeed').addEventListener('input', updateSpeedDisplay);
    
    // Initialize on load
    window.addEventListener('load', () => {
      updateSpeedDisplay();
      setTimeout(initializeWidgets, 500);
    });
  </script>
</body>
</html>